---
title: парадигма программного доступа к данным Аналитика
description: Общие сведения о высокоуровневом потоке шаблона вызова API для программной аналитики. Также рассматриваются API-интерфейсы для доступа к отчетам аналитики Partner Insights.
ms.topic: article
ms.service: partner-dashboard
ms.subservice: partnercenter-csp
author: shganesh-dev
ms.author: shganesh
ms.localizationpriority: medium
ms.date: 07/14/2021
ms.openlocfilehash: dcdd54fcc744fdb1683259203188c309a3949eff
ms.sourcegitcommit: 4f1702683336d54f24c0ba283f7d13dda581923d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/16/2021
ms.locfileid: "114375888"
---
# <a name="programmatic-access-paradigm"></a>Парадигма программного доступа

На этой схеме показан шаблон вызова API, используемый для создания нового шаблона отчета, планирования пользовательского отчета и получения данных об ошибках.

:::image type="content" source="images/insights/prog-acc-paradigm.png" alt-text="Поток высокого уровня":::
***Рис. 1. поток высокого уровня в шаблоне вызова API***

Этот список содержит дополнительные сведения о рис. 1.

1. Клиентское приложение может определить схему или шаблон пользовательского отчета, вызвав [API создания запроса отчета](#create-report-query-api). Кроме того, можно выбрать шаблон отчета (QueryId) из примеров библиотеки шаблонов отчетов, перечисленных [здесь.](insights-programmatic-system-queries.md)
2. При успешном выполнении API создания запросов отчета возвращает QueryId.
3. Затем клиентскому приложению необходимо вызвать [API создания отчета](#create-report-api) с помощью QueryId вместе с датой начала отчета, интервалом повтора, повторением и необязательным URI обратного вызова.
4. При успешном выполнении [API создания отчета](#create-report-api) возвращает идентификатор reportID.
5. Клиентское приложение получает уведомления по URL-адресу обратного вызова, как только данные отчета готовы к скачиванию.
6. Затем клиентское приложение использует [API получения отчетов для выполнения](#get-report-execution-api) запроса состояния отчета с идентификатором отчета и диапазоном дат.
7. При успешном выполнении возвращается ссылка на скачивание отчета, после чего приложение может инициировать скачивание данных.

## <a name="report-query-language-specification"></a>Спецификация языка запросов отчетов

В то время как мы предоставляем [системные запросы](insights-programmatic-system-queries.md) , которые можно использовать для создания отчетов, можно также создавать собственные запросы на основе бизнес-потребностей. Дополнительные сведения о пользовательских запросах см. в разделе [Спецификация настраиваемого запроса](insights-programmatic-custom-query.md).

## <a name="create-report-query-api"></a>API создания запросов отчетов

API помогает создавать пользовательские запросы, определяющие набор данных, из которого должны быть экспортированы столбцы и метрики. Он позволяет гибко создавать шаблоны отчетов с учетом потребностей организации.  

Вы также можете использовать [системные запросы](insights-programmatic-system-queries.md), которые предоставляем мы. Если пользовательские шаблоны отчетов не нужны, можно вызвать [API Create Report](#create-report-api) напрямую с помощью куеридс системных запросов.  

В следующем примере показано, как создать настраиваемый запрос для получения 10 лучших клиентов по доходу за прошлый месяц.

### <a name="request-syntax"></a>Синтаксис запроса

|    Метод     |    Универсальный код ресурса (URI) запроса     |
|----- | -----|
|    POST     |    `https://api.partnercenter.microsoft.com/insights/v1/mpn/ScheduledQueries`|
|||

### <a name="request-header"></a>Заголовок запроса

|    Заголовок     |    Тип     |    Описание     |
|-------|-----|------|
|    Авторизация     |    строка |Обязательный. Маркер доступа Azure Active Directory (Azure AD). Формат:  `Bearer <token>` .|
|    Content-Type     |строка |`Application/JSON` |
||||

### <a name="path-parameter"></a>Параметр пути

None

### <a name="query-parameter"></a>Параметр запроса

None

### <a name="sample-request-payload"></a>Пример полезных данных запроса

```json
{ 
  "Name": "CustomersRevenueQuery", 
  "Description": "Query to get top 10 customers by revenue for last month", 
  "Query": "SELECT CustomerName, Product, BilledRevenueUSD FROM CustomersAndTenants ORDER BY BilledRevenueUSD LIMIT 10 TIMESPAN LAST_MONTH" 
}
```

### <a name="glossary"></a>Глоссарий

В этой таблице приводятся основные определения элементов в полезных данных запроса.

|Параметр|    Обязательно     |    Описание     |    Допустимые значения     |
|-----|    -----    |    -----    |    -----    |
|Имя |    Да     |    Понятное имя запроса     |    строка     |
|    Описание     |    Нет     |    Описание данных, возвращаемых запросом     |    строка     |
|    Запрос     |    Да     |    Строка запроса отчета     |    Тип данных: строка <br> [Пользовательский запрос](insights-programmatic-custom-query.md) с учетом потребностей организации |
|        |        |        |        |

> [!Note]
> Примеры [запросов см.](insights-programmatic-sample-queries.md) в примерах пользовательских запросов.

### <a name="sample-response"></a>Пример ответа

Полезные данные ответа имеют следующий формат:

Коды ответов: 200, 400, 401, 403, 500

Пример полезных данных ответа:

```json
{ 
  "value": [ 
    { 
      "queryId": "ec8366a4-d96e-4194-8c37-d5dbc0639033",
      "name": "CustomersRevenueQuery",
      "description": "Query to get top 10 customers by revenue for last month",
      "query": "SELECT CustomerName, Product, BilledRevenueUSD FROM CustomersAndTenants ORDER BY BilledRevenueUSD LIMIT 10 TIMESPAN LAST_MONTH",
      "type": "userDefined",
      "user": "GAUser@PITEST2.ccsctp.net", 
      "createdTime": "2021-03-30T12:52:39Z" 
    }
  ], 
  "nextLink": null,
  "totalCount": 1,
  "message": "Query created successfully",
  "statusCode": 200,
  "dataRedacted": false
} 
```

### <a name="glossary"></a>Глоссарий

В этой таблице приводятся основные определения элементов в полезных данных запроса.

|    Параметр     |    Описание     |
|    ----    |    ----    |
|    QueryId     |    Универсальный уникальный идентификатор (UUID) созданного запроса     |
|    Имя     |    Понятное имя, присвоенное запросу в полезных данных запроса     |
|    Описание     |    Описание, заданное при создании запроса     |
|    Запрос     |    Запрос отчета, передаваемый как входные данные при создании запроса     |
|    Тип     |    Установите значение `userDefined`     |
|    Пользователь     |    Идентификатор пользователя, используемый для создания запроса     |
|    CreatedTime     |    Время создания запроса в формате UTC: гггг-мм-ddTчч: мм: ссZ     |
|    TotalCount     |    Количество наборов данных в массиве Value     |
|    StatusCode     |    Код результата <br> Возможные значения — 200, 400, 401, 403, 500     |
|    message     |    Сообщение о состоянии из выполнения API     |
|        |        |

## <a name="create-report-api"></a>API создания отчетов

При успешном создании пользовательского шаблона отчета и получении QueryID в ответе на [запрос создания отчета](#create-report-query-api) этот API можно вызвать, чтобы запланировать выполнение запроса с регулярными интервалами. Вы можете настроить частоту и расписание доставки отчета.
Для предоставляемых нами системных запросов API создания отчетов также можно вызывать с помощью [QueryId](insights-programmatic-system-queries.md).

### <a name="callback-url"></a>URL-адрес обратного вызова

API создания отчета принимает URL-адрес обратного вызова. Этот URL-адрес будет вызываться после успешного создания отчета. URL-адрес обратного вызова должен иметь открытый доступ. Кроме URL-адреса, можно также предоставить метод обратного вызова. Метод обратного вызова может иметь только значение "GET" или "POST". Метод по умолчанию, если значение не передается "POST". Идентификатор reportID, который завершил создание, всегда будет передаваться обратно во время обратного вызова.

Обратный вызов: если передан URL-адрес `https://www.contosso.com/callback` , то вызываемый URL-адрес обратной передачи будет `https://www.contosso.com/callback/<reportID>` 

ПОЛУЧИТЬ обратный вызов: если передан URL-адрес `https://www.contosso.com/callback` , то вызываемый URL-адрес обратной передачи будет `https://www.contosso.com/callback?reportId=<reportID>` 

### <a name="executenow-reports"></a>Отчеты Ексекутенов

Существует возможность создания отчета без планирования. Полезные данные API создания отчета могут принимать параметр `ExecuteNow` , который будет помещать отчет в очередь для создания, как только будет вызван API. Если `ExecuteNow` для задано значение true, поля: `StartTime` , `RecurrenceCount` , `RecurrenceInterval` не учитываются, так как эти отчеты не запланированы.

При значении true можно передавать два дополнительных поля `ExecuteNow` , `QueryStartTime` и `QueryEndTime` . Эти два поля будут переопределять `TIMESPAN` поле в запросе. Эти поля не применяются к запланированным отчетам, так как данные будут непрерывно созданы в течение фиксированного периода времени, который не изменяется.

### <a name="request-syntax"></a>Синтаксис запроса

|    Метод     |    Универсальный код ресурса (URI) запроса     |
|----- | -----|
|    POST     |`https://api.partnercenter.microsoft.com/insights/v1/mpn/ScheduledReport` |

### <a name="request-header"></a>Заголовок запроса

|    Заголовок     |    Тип     |    Описание     |
|-------|-----|------|
|    Авторизация     |    строка |Обязательный. Маркер доступа Azure Active Directory (Azure AD). Формат:  `Bearer <token>` .|
|    Content-Type     |строка |`Application/JSON` |

### <a name="path-parameter"></a>Параметр пути

None

### <a name="query-parameter"></a>Параметр запроса

None

### <a name="sample-request-payload"></a>Пример полезных данных запроса

```json
{
  "ReportName": "Top10_CustomersReport",
  "Description": "Top 10 customers by revenue for last month",
  "QueryId": "ec8366a4-d96e-4194-8c37-d5dbc0639033",
  "StartTime": "2021-03-31T18:41:00Z",
  "ExecuteNow": false,
  "QueryStartTime": null,
  "QueryEndTime": null,
  "RecurrenceInterval": 24,
  "RecurrenceCount": 100,
  "Format": "CSV",
  "CallbackUrl": "https://<SampleCallbackUrl>",
  "CallbackMethod": "GET"
}
```

### <a name="glossary"></a>Глоссарий

Основные определения элементов в полезных данных запроса приведены ниже.

|    Параметр     |    Обязательно     |    Описание     |    Допустимые значения     |
|    ----    |    ----    |    ----    |    ----    |
|    ReportName     |    Да     |    Имя, назначаемое отчету     |    строка     |
|    Описание     |    Нет     |    Описание созданного отчета     |    строка     |
|    QueryId     |    Да     |    Идентификатор запроса отчета     |    строка     |
|    StartTime     |    Да     |    Метка времени в формате UTC, после которой начнется создание отчета. <br> Требуемый формат: гггг-мм-ддTчч:мм:ссZ       |    строка     |
|    ексекутенов     |    Нет     |    Этот параметр следует использовать для создания отчета, который будет выполняться только один раз. `StartTime``RecurrenceInterval`и `RecurrenceCount` не учитываются, если задано значение true. Отчет немедленно выполняется в асинхронном режиме     |    true/false     |
|    QueryStartTime     |    Нет     |    Дополнительно указывает время начала для запроса на извлечение данных. Этот параметр применим только для одного отчета о выполнении, для которого `ExecuteNow` задано значение true. Установка этого параметра переопределяет значения `TIMESPAN` , заданные в запросе. Требуемый формат: гггг-мм-ддTчч:мм:ссZ     |    Отметка времени в виде строки     |
|    QueryEndTime     |    Нет     |    Дополнительно указывает время окончания для запроса на извлечение данных. Этот параметр применим только для одного отчета о выполнении, для которого `ExecuteNow` задано значение true. Установка этого параметра переопределяет значения `TIMESPAN` , заданные в запросе. Требуемый формат: гггг-мм-ддTчч:мм:ссZ     |    Отметка времени в виде строки     |
|    рекурренцеинтервал     |    Да     |    Периодичность создания отчета в часах. <br> Минимальное значение равно 4, а максимальное значение — 2160.      |    Целое число     |
|    рекурренцекаунт     |    Нет     |    Число создаваемых отчетов.     |    Целое число     |
|    Формат     |    Нет     |    Формат экспортируемого файла. <br> Значение по умолчанию — CSV.    |    "CSV"/"TSV"     |
|    CallbackUrl     |    Нет     |    Общедоступный URL-адрес, который можно дополнительно настроить в качестве назначения обратного вызова     |    Строка (URL-адрес HTTP)     |
|    каллбаккмесод     |    Нет     |    Метод, используемый для обратного вызова     |    GET/POST     |
|        |        |        |        |

### <a name="sample-response"></a>Пример ответа

Полезные данные ответа имеют следующий формат:

Коды ответов: 200, 400, 401, 403, 404, 500

Пример полезных данных ответа:

```json
{ 
  "value": [
    { 
      "reportId": "d9548477-16d4-492a-bf9c-0cf91a9f69bf", 
      "reportName": "Top10_CustomersReport", 
      "description": "Top 10 customers by revenue for last month", 
      "queryId": "ec8366a4-d96e-4194-8c37-d5dbc0639033", 
      "query": "SELECT CustomerName, Product, BilledRevenueUSD FROM CustomersAndTenants ORDER BY BilledRevenueUSD LIMIT 10 TIMESPAN LAST_MONTH", 
      "user": "GAUser@PITEST2.ccsctp.net", 
      "createdTime": "2021-03-30T13:11:58Z", 
      "modifiedTime": null, 
      "executeNow": false, 
      "startTime": "2021-03-31T18:41:00Z", 
      "reportStatus": "Active", 
      "recurrenceInterval": 24, 
      "recurrenceCount": 100, 
      "callbackUrl": "https://<SampleCallbackUrl>", 
      "callbackMethod": "GET", 
      "format": "csv"
    } 
  ], 
  "nextLink": null, 
  "totalCount": 1, 
  "message": "Report created successfully", 
  "statusCode": 200, 
  "dataRedacted": false 
}
```

### <a name="glossary"></a>Глоссарий

Основные определения элементов в ответе представлены ниже:

|    Параметр     |    Описание     |
|    ----    |    ----    |
|    ReportId     |    Универсальный уникальный идентификатор (UUID) созданного отчета     |
|    ReportName     |    Имя, присвоенное отчету в полезных данных запроса     |
|    Описание     |    Описание, заданное при создании отчета     |
|    QueryId     |    Идентификатор запроса, переданный во время создания отчета     |
|    Запрос     |    Текст запроса, который будет выполнен для этого отчета     |
|    Пользователь     |    Идентификатор пользователя, используемый для создания отчета     |
|    CreatedTime     |    Время создания отчета в формате UTC: гггг-мм-ddTчч: мм: ссZ     |
|    ModifiedTime     |    Время последнего изменения отчета в формате UTC: гггг-мм-ddTчч: мм: ссZ     |
|    ексекутенов     |    `ExecuteNow` флаг, установленный на момент создания отчета     |
|    StartTime     |    Время начала выполнения отчета в формате UTC: гггг-мм-ddTчч: мм: ссZ     |
|    репортстатус     |    Состояние выполнения отчета. Возможные значения: `Paused` , `Active` и. `Inactive`     |
|    рекурренцеинтервал     |    Интервал повторения, указанный при создании отчета     |
|    рекурренцекаунт     |    Число повторений, указанное при создании отчета.      |
|    CallbackUrl     |    URL-адрес обратного вызова, указанный в запросе     |
|    каллбаккмесод     |    Метод обратного вызова, указанный в запросе     |
|    Формат     |    Формат файлов отчета. Возможные значения: `CSV` или `TSV` .     |
|    TotalCount     |    Число записей в массиве значений     |
|    StatusCode     |    Код результата     |
|    message     |    Возможные значения: 200, 400, 401, 403, 500. Сообщение о состоянии из выполнения API     |
|        |        |

## <a name="get-report-execution-api"></a>Получение API выполнения отчета

Этот метод можно использовать для запроса состояния выполнения отчета с помощью идентификатор reportID, полученной из [API создания отчета](#create-report-api). Если отчет готов к скачиванию, метод возвращает ссылку для скачивания отчета. В противном случае метод возвращает состояние. Этот API также можно использовать для получения всех выполнений определенного отчета.  

>[!IMPORTANT]
>Этот API имеет параметры запроса по умолчанию, заданные для `executionStatus=Completed` и `getLatestExecution=true` . В связи с этим вызов API до первого успешного выполнения отчета возвращает 404. Для получения ожидающих выполнений можно использовать параметр `executionStatus=Pending`.

### <a name="request-syntax"></a>Синтаксис запроса

|    Метод     |    Универсальный код ресурса (URI) запроса     |
|----- | -----|
|    GET    |`https://api.partnercenter.microsoft.com/insights/v1/mpn/ScheduledReport/execution/{reportId}?executionId={executionId}&executionStatus={executionStatus}&getLatestExecution={getLatestExecution}`  |

### <a name="request-header"></a>Заголовок запроса

|    Заголовок     |    Тип     |    Описание     |
|-------|-----|------|
|    Авторизация     |    строка |Обязательный. Маркер доступа Azure Active Directory (Azure AD). Формат:  `Bearer <token>` .|
|    Content-Type     |строка |`Application/JSON` |

### <a name="path-parameter"></a>Параметр пути

|    имени параметра    |    Обязательно    |    Тип    |    Описание    |
|    ----    |    ----    |    ----    |    ----    |
|    reportId    |    Да    |    строка    |    Фильтр для получения сведений о выполнении только отчетов с идентификатор reportID, указанными в этом аргументе. Несколько Репортидс можно указать, разделив их точкой с запятой ";".    |
|        |        |        |        |

### <a name="query-parameter"></a>Параметр запроса

|    имени параметра    |    Обязательно    |    Тип    |    Описание    |
|    ----    |    ----    |    ----    |    ----    |
|    executionId    |    Нет    |    строка    |    Фильтр для получения сведений только об отчетах с executionId, указанными в этом аргументе. Несколько Ексекутионидс можно указать, разделив их точкой с запятой ";".    |
|    executionStatus    |    Нет    |    Строка или перечисление    |    Фильтр для получения сведений только об отчетах с Ексекутионстатус, указанными в этом аргументе. <br> Допустимые значения: `Pending` , `Running` `Paused` и `Completed` . <br> Значение по умолчанию — `Completed`. <br> Можно указать несколько состояний, разделяя их точкой с запятой ";".    |
|    жетлатестексекутион    |    Нет    |    Логическое    |    API возвратит сведения о последнем выполнении. По умолчанию этот параметр имеет значение true.<br> Если вы решили передать значение этого параметра как false, API возвратит последние 90 дней выполнения.    |
|        |        |        |        |

### <a name="sample-request-payload"></a>Пример полезных данных запроса

None

### <a name="sample-response"></a>Пример ответа

Полезные данные ответа имеют следующий формат:

Коды ответов: 200, 400, 401, 403, 404, 500

Пример полезных данных ответа:

```json
{
  "value": [
    {
      "executionId": "906931dc-4f2f-4195-bbb2-d7295c7550d3",
      "reportId": "d9548477-16d4-492a-bf9c-0cf91a9f69bf",
      "recurrenceInterval": 24,
      "recurrenceCount": 100,
      "callbackUrl": null,
      "callbackMethod": null,
      "format": "csv",
      "executionStatus": "Completed",
      "reportLocation": null,
      "reportAccessSecureLink": "https://<path to report for download>",
      "reportExpiryTime": null,
      "reportGeneratedTime": "2021-03-31T18:41:00Z"
    }
  ],
  "nextLink": null,
  "totalCount": 1,
  "message": null,
  "statusCode": 200,
  "dataRedacted": false
}
```

После выполнения отчета отобразится состояние выполнения `Completed`. Вы можете скачать отчет по URL-адресу, указанному в параметре `reportAccessSecureLink`.

### <a name="glossary"></a>Глоссарий

Основные определения элементов в ответе.

|    Параметр    |    Описание    |
|    ----    |    ----    |
|    ExecutionID    |    Универсальный уникальный идентификатор (UUID) экземпляра выполнения    |
|    ReportId    |    Идентификатор отчета, связанный с экземпляром выполнения    |
|    рекурренцеинтервал    |    Интервал повторения, указанный при создании отчета    |
|    рекурренцекаунт    |    Число повторений, указанное при создании отчета    |
|    CallbackUrl    |    URL-адрес обратного вызова, связанный с экземпляром выполнения    |
|    каллбаккмесод    |    Метод обратного вызова, связанный с экземпляром выполнения    |
|    Формат    |    Формат созданного файла по завершении выполнения    |
|    ExecutionStatus    |    Состояние экземпляра выполнения отчета. <br> Допустимые значения: `Pending`, `Running`, `Paused` и `Completed`    |
|    репортакцесссекурелинк    |Ссылка для безопасного доступа к отчету        |
|    репортекспиритиме    |    Время, при наступлении которого истекает срок действия ссылки на отчет, в формате UTC: гггг-мм-ddTчч: мм: ссZ    |
|    репортженератедтиме    |    Время создания отчета в формате UTC: гггг-мм-ddTHH: мм: ссZ    |
|    TotalCount    |    Количество наборов данных в массиве Value    |
|    StatusCode    |    Код результата <br> Возможные значения: 200, 400, 401, 403, 404 и 500    |
|    message    |    Сообщение о состоянии из выполнения API    |
|        |        |

## <a name="next-steps"></a>Дальнейшие действия

- Испытайте интерфейсы API с помощью [URL-адреса API Swagger](https://api.partnercenter.microsoft.com/insights/v1/mpn/swagger/index.html) .
- [Выполнение первого вызова API](insights-programmatic-first-api-call.md)